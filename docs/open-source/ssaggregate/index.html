<!DOCTYPE html><html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <title>Kyle Butts</title>
  <meta name="description" content="Academic site for Kyle Butts.">
  <!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=326374528"></script>
<script>let id = 326374528;

  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', id);
</script>

<link rel="stylesheet" href="/assets/f1a26159.8a3e8e58.css" />
<link rel="stylesheet" href="/assets/087686f5.906370df.css" /><script type="module">var n=function(){var e=document.createElement("link");e.rel="stylesheet",e.crossOrigin="anonymous",e.href="https://cdn.jsdelivr.net/npm/katex@0.15.0/dist/katex.min.css";var t=document.getElementsByTagName("head")[0];t.parentNode.insertBefore(e,t)},a=requestAnimationFrame||mozRequestAnimationFrame||webkitRequestAnimationFrame||msRequestAnimationFrame;a?a(n):window.addEventListener("load",n);
</script></head>

<body>
  <!-- Set theme on body -->
  <!-- Dark Mode --><script>
  // Check for dark mode preference at the OS level
  const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)");

  // Get the user's theme preference from local storage, if it's available
  let currentTheme = localStorage.getItem("theme");

  // Defaults
  if(currentTheme == null) {
    if(prefersDarkScheme.matches) {
      localStorage.setItem("theme", "dark")
      currentTheme = "dark"
    } else {
      localStorage.setItem("theme", "light")
      currentTheme = "light"
    }
  } 
  
  if (currentTheme == "dark") {
    document.body.classList.add("dark");
  } 
</script>


  <div class="min-h-screen w-full bg-mine-shaft-100 font-jetbrains text-mine-shaft-900 dark:bg-mine-shaft-900 dark:text-mine-shaft-50">
    <div class="pt-size-xs prose:pt-size-sm-md pb-size-2xl">
      <div class="content   
  ">
  <nav class="flex w-full flex-col justify-between gap-size-2xs pb-size-2xs border-b-[1px] border-mine-shaft-800 dark:border-mine-shaft-100">
  <div class="flex flex-wrap items-center justify-between">
    <h1 class="text-size-1 font-bold tracking-tight">
      <a href="/">Kyle Butts</a>
    </h1>

    <div class="flex items-center gap-size-2xs-xs">
      <a href="mailto:buttskyle96@gmail.com" aria-label="Send an email to Kyle Butts">
  <svg viewBox="0 0 24 24" class="block h-5 w-5 prose:h-6 prose:w-6 lg:h-7 lg:w-7 text-kelly-400 dark:text-kelly-500 cursor-pointer" astro-icon="heroicons-outline:at-symbol"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 1 0-8 0 4 4 0 0 0 8 0zm0 0v1.5a2.5 2.5 0 0 0 5 0V12a9 9 0 1 0-9 9m4.5-1.206a8.959 8.959 0 0 1-4.5 1.207"/></svg>
</a>

<a href="https://twitter.com/kylebutts/" aria-label="Kyle Butts' Twitter Account">
  <svg viewBox="0 0 256 256" class="block h-5 w-5 prose:h-6 prose:w-6 lg:h-7 lg:w-7 text-kelly-400 dark:text-kelly-500 cursor-pointer" astro-icon="ph:twitter-logo-duotone"><path fill="currentColor" d="m240 72-32.3 32.3A127.9 127.9 0 0 1 80 224c-32 0-40-12-40-12s32-12 48-36c0 0-64-32-48-120 0 0 40 40 88 48V88c0-22 18.5-40.3 40.5-40a40 40 0 0 1 36.2 24z" opacity=".2"/><path fill="currentColor" d="M247.4 68.9A8 8 0 0 0 240 64h-30.4a48.2 48.2 0 0 0-41-24A48.3 48.3 0 0 0 120 88v6.1C79.3 83.5 46 50.7 45.7 50.3a8 8 0 0 0-8.1-1.9 8.1 8.1 0 0 0-5.5 6.2c-8.7 48.2 5.8 80.5 19.5 99.1a108.6 108.6 0 0 0 24.7 24.4c-15.3 17.3-38.9 26.3-39.1 26.4a8 8 0 0 0-3.9 11.9c.8 1.2 3.8 5.1 11.1 8.8 9.1 4.5 21.1 6.8 35.6 6.8 70.5 0 129.5-54.3 135.5-124.2l30.2-30.1a8.4 8.4 0 0 0 1.7-8.8zm-45.3 29.7a7.8 7.8 0 0 0-2.3 5.2C195.7 166.7 143.1 216 80 216c-10.6 0-18-1.4-23.2-3.1 11.5-6.2 27.5-17 37.9-32.5a8 8 0 0 0 1-6.4 8.1 8.1 0 0 0-4.1-5.1c-.1-.1-14.9-7.8-27.6-25.3-14.4-19.8-20.5-43.9-18.1-71.7 15.8 13 46 34.2 80.8 40a8.1 8.1 0 0 0 6.5-1.8 8.2 8.2 0 0 0 2.8-6.1V88a32 32 0 0 1 61.3-12.8 8.1 8.1 0 0 0 7.4 4.8h16z"/></svg>
</a>

<a href="https://github.com/kylebutts/" aria-label="Kyle Butts' Github Account">
  <svg viewBox="0 0 24 24" class="block h-5 w-5 prose:h-6 prose:w-6 lg:h-7 lg:w-7 text-kelly-400 dark:text-kelly-500 cursor-pointer astro-L2AK7BS3" astro-icon="line-md:github-twotone">
    <g fill="none">
      <path fill="currentColor" fill-opacity=".3" d="M15 4.5c-.388-.1-1.332-.5-3-.5s-2.612.4-3 .5C8.475 4.075 7.062 3 5.5 3c-.344 1-.286 2.22 0 3-.75 1-1 2-1 3.5 0 2.188.483 3.582 1.5 4.5 1.017.918 2.111 1.375 3.5 1.5-.65.538-.5 1.874-.5 2.5v4h6v-4c0-.626.15-1.962-.5-2.5 1.389-.125 2.483-.582 3.5-1.5s1.5-2.313 1.5-4.5c0-1.5-.25-2.5-1-3.5.286-.78.344-2 0-3-1.563 0-2.975 1.075-3.5 1.5z" class="il-md-fill il-md-duration-0 il-md-delay-5"></path>
      <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4c1.668 0 2.612.4 3 .5.525-.425 1.938-1.5 3.5-1.5.344 1 .286 2.22 0 3 .75 1 1 2 1 3.5 0 2.188-.483 3.582-1.5 4.5-1.017.918-2.111 1.375-3.5 1.5.65.538.5 1.874.5 2.5v3M12 4c-1.668 0-2.612.4-3 .5C8.475 4.075 7.062 3 5.5 3c-.344 1-.286 2.22 0 3-.75 1-1 2-1 3.5 0 2.188.483 3.582 1.5 4.5 1.017.918 2.111 1.375 3.5 1.5-.65.538-.5 1.874-.5 2.5v3" class="il-md-length-40 il-md-duration-3 il-md-delay-0"></path>
      <path stroke="currentColor" stroke-linecap="round" stroke-width="1.5" d="M9 19c-1.406 0-2.844-.563-3.688-1.188C4.47 17.188 4.22 16.157 3 15.5" class="il-md-length-15 il-md-duration-2 il-md-delay-3"></path>
    </g>
  </svg>
</a>
      <script>
  toggleDarkMode = () => {
    // Get the user's theme preference from local storage, if it's available
    let currentTheme = localStorage.getItem("theme");

    // Defaults
    if (currentTheme == "light") {
      localStorage.setItem("theme", "dark")
      document.body.classList.add("dark")
    } else {
      localStorage.setItem("theme", "light")

      document.body.classList.remove("dark")
    }
  }
</script>

<button aria-label="Dark Mode Toggle" onclick="toggleDarkMode()">
  <svg viewBox="0 0 24 24" class="hidden dark:block h-5 w-5 prose:h-6 prose:w-6 lg:h-7 lg:w-7 text-kelly-400 dark:text-kelly-500 cursor-pointer" astro-icon="ic:twotone-wb-sunny"><path fill="currentColor" d="M12 7.5c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z" opacity=".3"/><path fill="currentColor" d="m5.34 6.25 1.42-1.41-1.8-1.79-1.41 1.41zM1 10.5h3v2H1zM11 .55h2V3.5h-2zm7.66 5.705-1.41-1.407 1.79-1.79 1.406 1.41zM17.24 18.16l1.79 1.8 1.41-1.41-1.8-1.79zM20 10.5h3v2h-3zm-8-5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zm-1 4h2v2.95h-2zm-7.45-.96 1.41 1.41 1.79-1.8-1.41-1.41z"/></svg>
  <svg viewBox="0 0 24 24" class="block dark:hidden h-5 w-5 prose:h-6 prose:w-6 lg:h-7 lg:w-7 text-kelly-400 dark:text-kelly-500 cursor-pointer" astro-icon="ic:twotone-dark-mode"><path fill="currentColor" d="M9.37 5.51A7.35 7.35 0 0 0 9.1 7.5c0 4.08 3.32 7.4 7.4 7.4.68 0 1.35-.09 1.99-.27A7.014 7.014 0 0 1 12 19c-3.86 0-7-3.14-7-7 0-2.93 1.81-5.45 4.37-6.49z" opacity=".3"/><path fill="currentColor" d="M9.37 5.51A7.35 7.35 0 0 0 9.1 7.5c0 4.08 3.32 7.4 7.4 7.4.68 0 1.35-.09 1.99-.27A7.014 7.014 0 0 1 12 19c-3.86 0-7-3.14-7-7 0-2.93 1.81-5.45 4.37-6.49zM12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/></svg>
</button>
    </div>
  </div>

  <ul class="gap-size-xs-sm flex flex-wrap text-size-0 font-light">
  <li class="relative hover:underline focus:underline decoration-alice-400">
    <a href="/papers/">Papers</a>
  </li><li class="relative hover:underline focus:underline decoration-alice-400">
    <a href="/open-source/">Open Source</a>
  </li><li class="relative hover:underline focus:underline decoration-alice-400">
    <a href="/teaching/">Teaching</a>
  </li><li class="relative hover:underline focus:underline decoration-alice-400">
    <a href="/blog/">Blog</a>
  </li>
</ul>
</nav>
</div>
        
      <div class="content flow prose 
  ">
  <h1 id="ssaggregate"><a href="https://github.com/kylebutts/ssaggregate">ssaggregate</a></h1>
<p>ssaggregate converts “location-level” variables in a shift-share IV
dataset to a dataset of exposure-weighted “industry-level” aggregates,
as described in <a href="https://uc6b7982a5764cd8c439602fced8.dl.dropboxusercontent.com/cd/0/inline2/BhreAHbJxwFfC325p4h_eLzzk9UsTf2ILha-np-4EXHOruYsWACqtHjKLIyjStn8b1nhJGZj99mEZjoc1pDf1wsdkRzdug_MrLsc_sd8e4nxTcDJpMpAvIXGMAnc5-okB1jakQRZUF9_rdgB8jOevC8Z8CAbgkl2OygM9ck3nljB4a3JYgc9A3URadjmnkXaGyjvz66G11Q7kfD3k7Dum9LEOEBi57gphYl8ncporsEGA0Kc3RfHKQN_mUqyjkekupU7ggmlZ6FgfdraXawftrf794iI1RTRIeX0OG1dLv-dIVIQ00wJCyCog3AlgkJIeU4_U3mW6Bif2MIlvkLNBSXhTmjxPK-SF5kdNDCR7dO-dBv3aumB_kJwmR0PUqniDThG51sC0KXWV-jXPoGaW0FcN2DWfVaohX2KREtcU1gJyg/file">Borusyak, Hull, and Jaravel
(2022)</a>.</p>
<h2 id="details">Details</h2>
<p>There are two ways to specify ssaggregate, depending on whether the
industry exposure weights are saved in “long” format (unique rows for
industry x location) in a separate dataset <code>shares</code> or in “wide” format
(unique rows for location and columns for each industry) as part of
<code>df</code>. In general <code>ssaggregate</code> will execute faster with “long” exposure
weights. See the examples for proper syntax in both cases.</p>
<p>In the “long” case the dataset in memory must be uniquely identified by
the cross-sectional variables in <code>l</code> and, when applicable, the period
identifiers in <code>t</code>. The separate shares dataset is given by <code>shares</code> and
should be uniquely indexed by the variables in <code>l</code> and <code>n</code> (and <code>t</code>,
when specified). <code>s</code> should contain the name of the exposure weight
variable, and the two datasets should contain only matching values of
<code>l</code> and <code>t</code>.</p>
<p>In the “wide” case the <code>s</code> option should contain the common stub of the
names of exposure weight variables, and <code>n</code> should contain the target
name of the shock identifier. For example, <code>s = &quot;share&quot;</code> should be
specified when the exposure variables are named share101, share102,
etc., with 101 and 102 being values of the shock identifier in <code>n</code>. The
string option should be specified when the shock identifer is a string
variable. Missing values in any of the exposure weight variables are
interpreted as zeros. The dataset in memory may be a panel or repeated
cross section, with periods indexed by <code>t</code>.</p>
<p>In both cases there should be no missing values for the location-level
variables, conditional on any if and in sample restrictions. The
resulting industry-level dataset will contain exposure-weighted
de-meaned averages of the location-level variables, along with the
average exposure weight <code>s_n</code>. This dataset will be be indexed by the
variables in <code>n</code> (and <code>t</code>, when specified).</p>
<p>When the <code>controls</code> option is included the location-level variables are
first residualized by the control variables. Formula following
<code>fixest::feols</code>. Fixed effects specified after “<code>|</code>”.The transformation
of variable <code>y</code> is also named <code>y</code>.</p>
<p>Including the addmissing option generates a “missing industry”
observation, with exposure weights equal to one minus the sum of a
location’s exposure weights. Borusyak, Hull, and Jaravel (2022)
recommend including this option when the the sum of exposure weights
varies across locations (see Section 3.2). The missing industry
observations will be identified by <code>NA</code> in <code>n</code>.</p>
<p>Note that no information on industry shocks is used in the execution of
ssaggregate; once run, users can merge shocks and any industry-level
controls to the aggregated dataset. They can then estimate and validate
quasi-experimental shift-share IV regressions with other Stata
procedures. See Section 4 of Borusyak, Hull, and Jaravel (2022) for
details and below for examples of such procedures.</p>
<h2 id="ssaggregate-examples"><code>ssaggregate</code> examples</h2>
<p>Using sepearate “long” share dataset:</p>
<pre class="shiki github-dark" style="background-color:#0d1117;color:#c9d1d9"><div class="language-id">r</div><div class="code-container"><code><div class="line"><span style="color:#79C0FF">library</span><span style="color:#C9D1D9">(ssaggregate)</span></div><div class="line"><span style="color:#79C0FF">library</span><span style="color:#C9D1D9">(fixest)</span></div><div class="line"></div><div class="line"><span style="color:#79C0FF">data</span><span style="color:#C9D1D9">(</span><span style="color:#A5D6FF">&quot;df&quot;</span><span style="color:#C9D1D9">)</span></div><div class="line"><span style="color:#79C0FF">data</span><span style="color:#C9D1D9">(</span><span style="color:#A5D6FF">&quot;shares&quot;</span><span style="color:#C9D1D9">)</span></div><div class="line"><span style="color:#FFA657">industry</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FFA657">ssaggregate</span><span style="color:#C9D1D9">(</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">data</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> df,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">shares</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> shares,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">vars</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> y </span><span style="color:#FF7B72">+</span><span style="color:#C9D1D9"> x </span><span style="color:#FF7B72">+</span><span style="color:#C9D1D9"> z </span><span style="color:#FF7B72">+</span><span style="color:#C9D1D9"> l_sh_routine33,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">weights</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;wei&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">n</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;sic87dd&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">t</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;year&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">s</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;ind_share&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">l</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;czone&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">controls</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> t2 </span><span style="color:#FF7B72">+</span><span style="color:#C9D1D9"> Lsh_manuf</span></div><div class="line"><span style="color:#C9D1D9">)</span></div><div class="line"></div><div class="line"><span style="color:#79C0FF">head</span><span style="color:#C9D1D9">(industry)</span></div><div class="line"><span style="color:#8B949E">#&gt;    sic87dd  year          s_n          y          x           z l_sh_routine33</span></div><div class="line"><span style="color:#8B949E">#&gt;      &lt;num&gt; &lt;num&gt;        &lt;num&gt;      &lt;num&gt;      &lt;num&gt;       &lt;num&gt;          &lt;num&gt;</span></div><div class="line"><span style="color:#8B949E">#&gt; 1:    2011  1990 5.991178e-03  0.9038660 -0.1129257 -0.15226680      -1.065246</span></div><div class="line"><span style="color:#8B949E">#&gt; 2:    2011  2000 4.729078e-03  0.5532335  0.3898516 -0.09367913      -1.178196</span></div><div class="line"><span style="color:#8B949E">#&gt; 3:    2015  1990 3.802834e-03  0.7228411 -0.4026864  0.08561252      -2.407878</span></div><div class="line"><span style="color:#8B949E">#&gt; 4:    2015  2000 4.638681e-03 -0.1133174 -0.1762856 -0.34968672      -2.320667</span></div><div class="line"><span style="color:#8B949E">#&gt; 5:    2021  1990 8.723289e-05  2.2034699  0.1183517 -0.03164776      -2.788844</span></div><div class="line"><span style="color:#8B949E">#&gt; 6:    2021  2000 4.436779e-05  0.3604907  0.2456597 -0.39783282      -1.195864</span></div></code></div></pre>
<p>Using “wide” shares in dataset:</p>
<pre class="shiki github-dark" style="background-color:#0d1117;color:#c9d1d9"><div class="language-id">r</div><div class="code-container"><code><div class="line"><span style="color:#79C0FF">data</span><span style="color:#C9D1D9">(</span><span style="color:#A5D6FF">&quot;df_wide&quot;</span><span style="color:#C9D1D9">)</span></div><div class="line"><span style="color:#FFA657">industry_df</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FFA657">ssaggregate</span><span style="color:#C9D1D9">(</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">data</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> df_wide,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">vars</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> y </span><span style="color:#FF7B72">+</span><span style="color:#C9D1D9"> x </span><span style="color:#FF7B72">+</span><span style="color:#C9D1D9"> z </span><span style="color:#FF7B72">+</span><span style="color:#C9D1D9"> l_sh_routine33,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">weights</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;wei&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">n</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;sic87dd&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">t</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;year&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">s</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;ind_share&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">controls</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> t2 </span><span style="color:#FF7B72">+</span><span style="color:#C9D1D9"> Lsh_manuf</span></div><div class="line"><span style="color:#C9D1D9">)</span></div><div class="line"><span style="color:#8B949E">#&gt; Warning: Invalid .internal.selfref detected and fixed by taking a (shallow)</span></div><div class="line"><span style="color:#8B949E">#&gt; copy of the data.table so that := can add this new column by reference. At an</span></div><div class="line"><span style="color:#8B949E">#&gt; earlier point, this data.table has been copied by R (or was created manually</span></div><div class="line"><span style="color:#8B949E">#&gt; using structure() or similar). Avoid names&lt;- and attr&lt;- which in R currently</span></div><div class="line"><span style="color:#8B949E">#&gt; (and oddly) may copy the whole data.table. Use set* syntax instead to avoid</span></div><div class="line"><span style="color:#8B949E">#&gt; copying: ?set, ?setnames and ?setattr. If this message doesn&#39;t help, please</span></div><div class="line"><span style="color:#8B949E">#&gt; report your use case to the data.table issue tracker so the root cause can be</span></div><div class="line"><span style="color:#8B949E">#&gt; fixed or this message improved.</span></div><div class="line"></div><div class="line"><span style="color:#79C0FF">head</span><span style="color:#C9D1D9">(industry_df)</span></div><div class="line"><span style="color:#8B949E">#&gt;    sic87dd  year          s_n          y          x           z l_sh_routine33</span></div><div class="line"><span style="color:#8B949E">#&gt;     &lt;char&gt; &lt;num&gt;        &lt;num&gt;      &lt;num&gt;      &lt;num&gt;       &lt;num&gt;          &lt;num&gt;</span></div><div class="line"><span style="color:#8B949E">#&gt; 1:    2011  1990 5.991178e-03  0.9038660 -0.1129257 -0.15226680      -1.065246</span></div><div class="line"><span style="color:#8B949E">#&gt; 2:    2011  2000 4.729078e-03  0.5532335  0.3898516 -0.09367913      -1.178196</span></div><div class="line"><span style="color:#8B949E">#&gt; 3:    2015  1990 3.802834e-03  0.7228411 -0.4026864  0.08561252      -2.407878</span></div><div class="line"><span style="color:#8B949E">#&gt; 4:    2015  2000 4.638681e-03 -0.1133174 -0.1762856 -0.34968672      -2.320667</span></div><div class="line"><span style="color:#8B949E">#&gt; 5:    2021  1990 8.723289e-05  2.2034699  0.1183517 -0.03164776      -2.788844</span></div><div class="line"><span style="color:#8B949E">#&gt; 6:    2021  2000 4.436779e-05  0.3604907  0.2456597 -0.39783282      -1.195864</span></div></code></div></pre>
<p>Including the “missing industry”:</p>
<pre class="shiki github-dark" style="background-color:#0d1117;color:#c9d1d9"><div class="language-id">r</div><div class="code-container"><code><div class="line"><span style="color:#79C0FF">data</span><span style="color:#C9D1D9">(</span><span style="color:#A5D6FF">&quot;df&quot;</span><span style="color:#C9D1D9">)</span></div><div class="line"><span style="color:#79C0FF">data</span><span style="color:#C9D1D9">(</span><span style="color:#A5D6FF">&quot;shares&quot;</span><span style="color:#C9D1D9">)</span></div><div class="line"><span style="color:#FFA657">industry_df</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FFA657">ssaggregate</span><span style="color:#C9D1D9">(</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">data</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> df,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">shares</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> shares,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">vars</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> y </span><span style="color:#FF7B72">+</span><span style="color:#C9D1D9"> x </span><span style="color:#FF7B72">+</span><span style="color:#C9D1D9"> z </span><span style="color:#FF7B72">+</span><span style="color:#C9D1D9"> l_sh_routine33,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">weights</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;wei&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">n</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;sic87dd&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">t</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;year&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">s</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;ind_share&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">l</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;czone&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">controls</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> t2 </span><span style="color:#FF7B72">+</span><span style="color:#C9D1D9"> Lsh_manuf,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">addmissing</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#79C0FF">TRUE</span></div><div class="line"><span style="color:#C9D1D9">)</span></div><div class="line"></div><div class="line"><span style="color:#79C0FF">head</span><span style="color:#C9D1D9">(industry_df)</span></div><div class="line"><span style="color:#8B949E">#&gt;    sic87dd  year          s_n          y          x           z l_sh_routine33</span></div><div class="line"><span style="color:#8B949E">#&gt;      &lt;num&gt; &lt;num&gt;        &lt;num&gt;      &lt;num&gt;      &lt;num&gt;       &lt;num&gt;          &lt;num&gt;</span></div><div class="line"><span style="color:#8B949E">#&gt; 1:    2011  1990 1.456902e-03  0.9038660 -0.1129257 -0.15226680      -1.065246</span></div><div class="line"><span style="color:#8B949E">#&gt; 2:    2011  2000 1.149991e-03  0.5532335  0.3898516 -0.09367913      -1.178196</span></div><div class="line"><span style="color:#8B949E">#&gt; 3:    2015  1990 9.247522e-04  0.7228411 -0.4026864  0.08561252      -2.407878</span></div><div class="line"><span style="color:#8B949E">#&gt; 4:    2015  2000 1.128009e-03 -0.1133174 -0.1762856 -0.34968672      -2.320667</span></div><div class="line"><span style="color:#8B949E">#&gt; 5:    2021  1990 2.121282e-05  2.2034699  0.1183517 -0.03164776      -2.788844</span></div><div class="line"><span style="color:#8B949E">#&gt; 6:    2021  2000 1.078912e-05  0.3604907  0.2456597 -0.39783282      -1.195864</span></div></code></div></pre>
<p>After aggregation, shocks and any shock-level controls can be merged on
to the new dataset. For example, after the previous command a user could
run</p>
<pre class="shiki github-dark" style="background-color:#0d1117;color:#c9d1d9"><div class="language-id">r</div><div class="code-container"><code><div class="line"><span style="color:#C9D1D9">industry_df[</span><span style="color:#79C0FF">is.na</span><span style="color:#C9D1D9">(sic87dd), sic87dd </span><span style="color:#FF7B72">:=</span><span style="color:#C9D1D9"> </span><span style="color:#79C0FF">0</span><span style="color:#C9D1D9">]</span></div><div class="line"><span style="color:#79C0FF">data</span><span style="color:#C9D1D9">(</span><span style="color:#A5D6FF">&quot;shocks&quot;</span><span style="color:#C9D1D9">)</span></div><div class="line"><span style="color:#79C0FF">data</span><span style="color:#C9D1D9">(</span><span style="color:#A5D6FF">&quot;industries&quot;</span><span style="color:#C9D1D9">)</span></div><div class="line"><span style="color:#FFA657">industry_df</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#79C0FF">merge</span><span style="color:#C9D1D9">(industry_df, shocks, </span><span style="color:#FFA657">by</span><span style="color:#FF7B72">=</span><span style="color:#79C0FF">c</span><span style="color:#C9D1D9">(</span><span style="color:#A5D6FF">&quot;sic87dd&quot;</span><span style="color:#C9D1D9">, </span><span style="color:#A5D6FF">&quot;year&quot;</span><span style="color:#C9D1D9">), </span><span style="color:#FFA657">all.x</span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9">T)</span></div><div class="line"><span style="color:#FFA657">industry_df</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#79C0FF">merge</span><span style="color:#C9D1D9">(industry_df, industries, </span><span style="color:#FFA657">by</span><span style="color:#FF7B72">=</span><span style="color:#79C0FF">c</span><span style="color:#C9D1D9">(</span><span style="color:#A5D6FF">&quot;sic87dd&quot;</span><span style="color:#C9D1D9">), </span><span style="color:#FFA657">all.x</span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9">T)</span></div><div class="line"></div><div class="line"><span style="color:#C9D1D9">industry_df[</span><span style="color:#79C0FF">is.na</span><span style="color:#C9D1D9">(g), </span><span style="color:#FFA657">let</span><span style="color:#C9D1D9">(</span><span style="color:#FFA657">g</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#79C0FF">0</span><span style="color:#C9D1D9">, </span><span style="color:#FFA657">year</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#79C0FF">0</span><span style="color:#C9D1D9">, </span><span style="color:#FFA657">sic3</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#79C0FF">0</span><span style="color:#C9D1D9">)]</span></div></code></div></pre>
<h2 id="shock-level-iv-regression-examples">Shock-level IV regression examples</h2>
<p>Basic shift-share IV:</p>
<pre class="shiki github-dark" style="background-color:#0d1117;color:#c9d1d9"><div class="language-id">r</div><div class="code-container"><code><div class="line"><span style="color:#79C0FF">fixest</span><span style="color:#FF7B72">::</span><span style="color:#FFA657">feols</span><span style="color:#C9D1D9">(y </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> year </span><span style="color:#FF7B72">|</span><span style="color:#C9D1D9"> </span><span style="color:#79C0FF">0</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">|</span><span style="color:#C9D1D9"> x </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> g, </span><span style="color:#FFA657">data</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> industry_df, </span></div><div class="line"><span style="color:#C9D1D9">              </span><span style="color:#FFA657">weights</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> s_n, </span><span style="color:#FFA657">vcov</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;hc1&quot;</span><span style="color:#C9D1D9">)</span></div><div class="line"><span style="color:#8B949E">#&gt; TSLS estimation, Dep. Var.: y, Endo.: x, Instr.: g</span></div><div class="line"><span style="color:#8B949E">#&gt; Second stage: Dep. Var.: y</span></div><div class="line"><span style="color:#8B949E">#&gt; Observations: 796 </span></div><div class="line"><span style="color:#8B949E">#&gt; Standard-errors: Heteroskedasticity-robust </span></div><div class="line"><span style="color:#8B949E">#&gt;                 Estimate Std. Error   t value   Pr(&gt;|t|)    </span></div><div class="line"><span style="color:#8B949E">#&gt; (Intercept)  0.000088298   0.024946  0.003540 9.9718e-01    </span></div><div class="line"><span style="color:#8B949E">#&gt; fit_x       -0.464302730   0.087633 -5.298243 1.5162e-07 ***</span></div><div class="line"><span style="color:#8B949E">#&gt; year        -0.000000182   0.000021 -0.008516 9.9321e-01    </span></div><div class="line"><span style="color:#8B949E">#&gt; ---</span></div><div class="line"><span style="color:#8B949E">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></div><div class="line"><span style="color:#8B949E">#&gt; RMSE: 0.009783   Adj. R2: 0.149066</span></div><div class="line"><span style="color:#8B949E">#&gt; F-test (1st stage), x: stat = 160.1    , p &lt; 2.2e-16 , on 1 and 793 DoF.</span></div><div class="line"><span style="color:#8B949E">#&gt;            Wu-Hausman: stat =   1.02823, p = 0.310884, on 1 and 792 DoF.</span></div></code></div></pre>
<p>Conditional shift-share IV with clustered standard errors:</p>
<pre class="shiki github-dark" style="background-color:#0d1117;color:#c9d1d9"><div class="language-id">r</div><div class="code-container"><code><div class="line"><span style="color:#79C0FF">fixest</span><span style="color:#FF7B72">::</span><span style="color:#FFA657">feols</span><span style="color:#C9D1D9">(y </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> year </span><span style="color:#FF7B72">|</span><span style="color:#C9D1D9"> </span><span style="color:#79C0FF">0</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">|</span><span style="color:#C9D1D9"> x </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> g, </span><span style="color:#FFA657">data</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> industry_df[g </span><span style="color:#FF7B72">&lt;</span><span style="color:#C9D1D9"> </span><span style="color:#79C0FF">45</span><span style="color:#C9D1D9">, ], </span></div><div class="line"><span style="color:#C9D1D9">              </span><span style="color:#FFA657">weights</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> s_n, </span><span style="color:#FFA657">cluster</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> sic3)</span></div><div class="line"><span style="color:#8B949E">#&gt; TSLS estimation, Dep. Var.: y, Endo.: x, Instr.: g</span></div><div class="line"><span style="color:#8B949E">#&gt; Second stage: Dep. Var.: y</span></div><div class="line"><span style="color:#8B949E">#&gt; Observations: 757 </span></div><div class="line"><span style="color:#8B949E">#&gt; Standard-errors: Clustered (sic3) </span></div><div class="line"><span style="color:#8B949E">#&gt;                Estimate Std. Error   t value   Pr(&gt;|t|)    </span></div><div class="line"><span style="color:#8B949E">#&gt; (Intercept)  0.00007456   0.000081  0.918778 3.5987e-01    </span></div><div class="line"><span style="color:#8B949E">#&gt; fit_x       -0.59570752   0.141843 -4.199764 4.8623e-05 ***</span></div><div class="line"><span style="color:#8B949E">#&gt; year        -0.00000135   0.000019 -0.070177 9.4416e-01    </span></div><div class="line"><span style="color:#8B949E">#&gt; ---</span></div><div class="line"><span style="color:#8B949E">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></div><div class="line"><span style="color:#8B949E">#&gt; RMSE: 0.009944   Adj. R2: 0.153545</span></div><div class="line"><span style="color:#8B949E">#&gt; F-test (1st stage), x: stat = 236.6     , p &lt; 2.2e-16 , on 1 and 754 DoF.</span></div><div class="line"><span style="color:#8B949E">#&gt;            Wu-Hausman: stat =   3.958e-5, p = 0.994982, on 1 and 753 DoF.</span></div></code></div></pre>
<p>Shift-share reduced form regression (<code>y</code> on <code>z</code>):</p>
<pre class="shiki github-dark" style="background-color:#0d1117;color:#c9d1d9"><div class="language-id">r</div><div class="code-container"><code><div class="line"><span style="color:#79C0FF">fixest</span><span style="color:#FF7B72">::</span><span style="color:#FFA657">feols</span><span style="color:#C9D1D9">(y </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> year </span><span style="color:#FF7B72">|</span><span style="color:#C9D1D9"> </span><span style="color:#79C0FF">0</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">|</span><span style="color:#C9D1D9"> z </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> g, </span><span style="color:#FFA657">data</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> industry_df, </span></div><div class="line"><span style="color:#C9D1D9">              </span><span style="color:#FFA657">weights</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> s_n, </span><span style="color:#FFA657">vcov</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;hc1&quot;</span><span style="color:#C9D1D9">)</span></div><div class="line"><span style="color:#8B949E">#&gt; TSLS estimation, Dep. Var.: y, Endo.: z, Instr.: g</span></div><div class="line"><span style="color:#8B949E">#&gt; Second stage: Dep. Var.: y</span></div><div class="line"><span style="color:#8B949E">#&gt; Observations: 796 </span></div><div class="line"><span style="color:#8B949E">#&gt; Standard-errors: Heteroskedasticity-robust </span></div><div class="line"><span style="color:#8B949E">#&gt;                 Estimate Std. Error   t value   Pr(&gt;|t|)    </span></div><div class="line"><span style="color:#8B949E">#&gt; (Intercept)  0.000103048   0.029114  0.003540 0.99717677    </span></div><div class="line"><span style="color:#8B949E">#&gt; fit_z       -0.318593633   0.067554 -4.716113 0.00000284 ***</span></div><div class="line"><span style="color:#8B949E">#&gt; year        -0.000000212   0.000023 -0.009319 0.99256692    </span></div><div class="line"><span style="color:#8B949E">#&gt; ---</span></div><div class="line"><span style="color:#8B949E">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></div><div class="line"><span style="color:#8B949E">#&gt; RMSE: 0.009811   Adj. R2: 0.144315</span></div><div class="line"><span style="color:#8B949E">#&gt; F-test (1st stage), z: stat = 377.3, p &lt; 2.2e-16 , on 1 and 793 DoF.</span></div><div class="line"><span style="color:#8B949E">#&gt;            Wu-Hausman: stat =  18.5, p = 1.958e-5, on 1 and 792 DoF.</span></div></code></div></pre>
<p>Shock-level balance check:</p>
<pre class="shiki github-dark" style="background-color:#0d1117;color:#c9d1d9"><div class="language-id">r</div><div class="code-container"><code><div class="line"><span style="color:#79C0FF">fixest</span><span style="color:#FF7B72">::</span><span style="color:#FFA657">feols</span><span style="color:#C9D1D9">(l_sh_routine33 </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> g </span><span style="color:#FF7B72">+</span><span style="color:#C9D1D9"> year, </span><span style="color:#FFA657">data</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> industry_df,</span></div><div class="line"><span style="color:#C9D1D9">              </span><span style="color:#FFA657">weights</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> s_n, </span><span style="color:#FFA657">vcov</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;hc1&quot;</span><span style="color:#C9D1D9">)</span></div><div class="line"><span style="color:#8B949E">#&gt; OLS estimation, Dep. Var.: l_sh_routine33</span></div><div class="line"><span style="color:#8B949E">#&gt; Observations: 796 </span></div><div class="line"><span style="color:#8B949E">#&gt; Standard-errors: Heteroskedasticity-robust </span></div><div class="line"><span style="color:#8B949E">#&gt;                Estimate Std. Error   t value Pr(&gt;|t|) </span></div><div class="line"><span style="color:#8B949E">#&gt; (Intercept)  0.00002335   0.009037  0.002583  0.99794 </span></div><div class="line"><span style="color:#8B949E">#&gt; g           -0.00244245   0.001645 -1.484810  0.13799 </span></div><div class="line"><span style="color:#8B949E">#&gt; year         0.00000898   0.000043  0.208076  0.83522 </span></div><div class="line"><span style="color:#8B949E">#&gt; ---</span></div><div class="line"><span style="color:#8B949E">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></div><div class="line"><span style="color:#8B949E">#&gt; RMSE: 0.018808   Adj. R2: -2.71e-4</span></div></code></div></pre>
<p><em>See Borusyak, Hull, and Jaravel (2022) for other examples of
shock-level analyses and guidance on specifying and validating a
quasi-experimental shift-share IV.</em></p>
</div>
    </div>
  </div>

  <!-- Katex for equations -->
  
</body>

</html>