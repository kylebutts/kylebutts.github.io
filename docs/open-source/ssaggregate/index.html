<!DOCTYPE html><html lang="en" class="astro-RSPDPQNQ">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <title>Kyle Butts</title>
  <meta name="description" content="Academic site for Kyle Butts.">

  <!-- Katex for equations -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.0/dist/katex.min.css" cross-origin="anonymous" rel="preload">

  <!-- Tailwind CSS -->
  
<link rel="stylesheet" href="/assets/31fd0efb.8efb79ad.css" />
<link rel="stylesheet" href="/assets/11504762.4a6c8f87.css" /></head>

<body>
  <!-- Dark Mode --><script src="">
  // Check for dark mode preference at the OS level
  const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)");

  // Get the user's theme preference from local storage, if it's available
  let currentTheme = localStorage.getItem("theme");

  // Defaults
  if(currentTheme == null) {
    if(prefersDarkScheme.matches) {
      localStorage.setItem("theme", "dark")
      currentTheme = "dark"
    } else {
      localStorage.setItem("theme", "light")
      currentTheme = "light"
    }
  } 
  
  if (currentTheme == "dark") {
    document.body.classList.add("dark");
  } 
</script>


  <div class="min-h-screen w-full bg-mine-shaft-100 font-jetbrains text-mine-shaft-900 dark:bg-mine-shaft-900 dark:text-mine-shaft-50 astro-RSPDPQNQ">
    <div class="pt-size-xs prose:pt-size-sm-md pb-size-2xl astro-RSPDPQNQ">
      <div class="content   
  ">
  <nav class="flex w-full flex-row prose:flex-col justify-between gap-size-2xs pb-size-2xs border-b-[1px] border-mine-shaft-800 dark:border-mine-shaft-100">
  <h1 class="text-size-1 font-bold tracking-tight">
    <a href="/">Kyle Butts</a>
  </h1>
  <div class="flex prose:items-end justify-between">
    <ul class="gap-x-size-xs-sm hidden prose:flex text-size-0 font-light">
  <li class="relative hover:underline focus:underline decoration-alice-400">
  </li><li class="relative hover:underline focus:underline decoration-alice-400">
  </li><li class="relative hover:underline focus:underline decoration-alice-400">
  </li><li class="relative hover:underline focus:underline decoration-alice-400">
  </li>
</ul>
    <div class="flex items-center gap-size-3xs">
      <style>astro-island,astro-slot{display:contents}</style><script>(self.Astro=self.Astro||{}).idle=a=>{const e=async()=>{await(await a())()};"requestIdleCallback"in window?window.requestIdleCallback(e):setTimeout(e,200)};var a;{const l={0:t=>t,1:t=>JSON.parse(t,o),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(JSON.parse(t,o)),5:t=>new Set(JSON.parse(t,o)),6:t=>BigInt(t),7:t=>new URL(t)},o=(t,s)=>{if(t===""||!Array.isArray(s))return s;const[e,i]=s;return e in l?l[e](i):void 0};customElements.get("astro-island")||customElements.define("astro-island",(a=class extends HTMLElement{constructor(){super(...arguments);this.hydrate=()=>{if(!this.hydrator||this.parentElement?.closest("astro-island[ssr]"))return;const s=this.querySelectorAll("astro-slot"),e={},i=this.querySelectorAll("template[data-astro-template]");for(const r of i)!r.closest(this.tagName)?.isSameNode(this)||(e[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove());for(const r of s)!r.closest(this.tagName)?.isSameNode(this)||(e[r.getAttribute("name")||"default"]=r.innerHTML);const n=this.hasAttribute("props")?JSON.parse(this.getAttribute("props"),o):{};this.hydrator(this)(this.Component,n,e,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),window.removeEventListener("astro:hydrate",this.hydrate),window.dispatchEvent(new CustomEvent("astro:hydrate"))}}async connectedCallback(){window.addEventListener("astro:hydrate",this.hydrate),await import(this.getAttribute("before-hydration-url"));const s=JSON.parse(this.getAttribute("opts"));Astro[this.getAttribute("client")](async()=>{const e=this.getAttribute("renderer-url"),[i,{default:n}]=await Promise.all([import(this.getAttribute("component-url")),e?import(e):()=>()=>{}]);return this.Component=i[this.getAttribute("component-export")||"default"],this.hydrator=n,this.hydrate},s,this)}attributeChangedCallback(){this.hydrator&&this.hydrate()}},a.observedAttributes=["props"],a))}</script><astro-island uid="Z8OkLW" component-url="/MenuItemsDropdown.a2de8a62.js" component-export="default" renderer-url="/client.f71bfba5.js" props="{}" ssr="" client="idle" before-hydration-url="data:text/javascript;charset=utf-8,//[no before-hydration script]" opts="{&quot;name&quot;:&quot;MenuItemsDropdown&quot;,&quot;value&quot;:true}"><div class="relative z-10"><div class="flex items-center" id="headlessui-menu-button-:R1:" aria-haspopup="true" aria-expanded="false"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="focus:outline-none focus-visible:ring-2 focus-visible:ring-white focus-visible:ring-opacity-75 h-5 w-5 text-alice-500 dark:text-alice-400"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg></div></div></astro-island>
      <astro-island uid="2h1W7H" component-url="/DarkModeButton.8c1a99b2.js" component-export="default" renderer-url="/client.f71bfba5.js" props="{}" ssr="" client="idle" before-hydration-url="data:text/javascript;charset=utf-8,//[no before-hydration script]" opts="{&quot;name&quot;:&quot;DarkModeButton&quot;,&quot;value&quot;:true}"><button aria-label="Dark Mode Toggle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="h-5 w-5 text-alice-500 dark:text-alice-400 cursor-pointer"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path></svg></button></astro-island>
    </div>
  </div>
</nav>
</div>
        <div class="content flow prose 
  ">
  <h1 id="ssaggregate"><a href="https://github.com/kylebutts/ssaggregate">ssaggregate</a></h1>
<p>ssaggregate converts “location-level” variables in a shift-share IV
dataset to a dataset of exposure-weighted “industry-level” aggregates,
as described in <a href="https://uc6b7982a5764cd8c439602fced8.dl.dropboxusercontent.com/cd/0/inline2/BhreAHbJxwFfC325p4h_eLzzk9UsTf2ILha-np-4EXHOruYsWACqtHjKLIyjStn8b1nhJGZj99mEZjoc1pDf1wsdkRzdug_MrLsc_sd8e4nxTcDJpMpAvIXGMAnc5-okB1jakQRZUF9_rdgB8jOevC8Z8CAbgkl2OygM9ck3nljB4a3JYgc9A3URadjmnkXaGyjvz66G11Q7kfD3k7Dum9LEOEBi57gphYl8ncporsEGA0Kc3RfHKQN_mUqyjkekupU7ggmlZ6FgfdraXawftrf794iI1RTRIeX0OG1dLv-dIVIQ00wJCyCog3AlgkJIeU4_U3mW6Bif2MIlvkLNBSXhTmjxPK-SF5kdNDCR7dO-dBv3aumB_kJwmR0PUqniDThG51sC0KXWV-jXPoGaW0FcN2DWfVaohX2KREtcU1gJyg/file">Borusyak, Hull, and Jaravel
(2022)</a>.</p>
<h2 id="details">Details</h2>
<p>There are two ways to specify ssaggregate, depending on whether the
industry exposure weights are saved in “long” format (unique rows for
industry x location) in a separate dataset <code>shares</code> or in “wide” format
(unique rows for location and columns for each industry) as part of
<code>df</code>. In general <code>ssaggregate</code> will execute faster with “long” exposure
weights. See the examples for proper syntax in both cases.</p>
<p>In the “long” case the dataset in memory must be uniquely identified by
the cross-sectional variables in <code>l</code> and, when applicable, the period
identifiers in <code>t</code>. The separate shares dataset is given by <code>shares</code> and
should be uniquely indexed by the variables in <code>l</code> and <code>n</code> (and <code>t</code>,
when specified). <code>s</code> should contain the name of the exposure weight
variable, and the two datasets should contain only matching values of
<code>l</code> and <code>t</code>.</p>
<p>In the “wide” case the <code>s</code> option should contain the common stub of the
names of exposure weight variables, and <code>n</code> should contain the target
name of the shock identifier. For example, <code>s = &quot;share&quot;</code> should be
specified when the exposure variables are named share101, share102,
etc., with 101 and 102 being values of the shock identifier in <code>n</code>. The
string option should be specified when the shock identifer is a string
variable. Missing values in any of the exposure weight variables are
interpreted as zeros. The dataset in memory may be a panel or repeated
cross section, with periods indexed by <code>t</code>.</p>
<p>In both cases there should be no missing values for the location-level
variables, conditional on any if and in sample restrictions. The
resulting industry-level dataset will contain exposure-weighted
de-meaned averages of the location-level variables, along with the
average exposure weight <code>s_n</code>. This dataset will be be indexed by the
variables in <code>n</code> (and <code>t</code>, when specified).</p>
<p>When the <code>controls</code> option is included the location-level variables are
first residualized by the control variables. Formula following
<code>fixest::feols</code>. Fixed effects specified after “<code>|</code>”.The transformation
of variable <code>y</code> is also named <code>y</code>.</p>
<p>Including the addmissing option generates a “missing industry”
observation, with exposure weights equal to one minus the sum of a
location’s exposure weights. Borusyak, Hull, and Jaravel (2022)
recommend including this option when the the sum of exposure weights
varies across locations (see Section 3.2). The missing industry
observations will be identified by <code>NA</code> in <code>n</code>.</p>
<p>Note that no information on industry shocks is used in the execution of
ssaggregate; once run, users can merge shocks and any industry-level
controls to the aggregated dataset. They can then estimate and validate
quasi-experimental shift-share IV regressions with other Stata
procedures. See Section 4 of Borusyak, Hull, and Jaravel (2022) for
details and below for examples of such procedures.</p>
<h2 id="ssaggregate-examples"><code>ssaggregate</code> examples</h2>
<p>Using sepearate “long” share dataset:</p>
<pre class="shiki github-dark" style="background-color:#0d1117;color:#c9d1d9"><div class="language-id">r</div><div class="code-container"><code><div class="line"><span style="color:#79C0FF">library</span><span style="color:#C9D1D9">(ssaggregate)</span></div><div class="line"><span style="color:#79C0FF">library</span><span style="color:#C9D1D9">(fixest)</span></div><div class="line"></div><div class="line"><span style="color:#79C0FF">data</span><span style="color:#C9D1D9">(</span><span style="color:#A5D6FF">&quot;df&quot;</span><span style="color:#C9D1D9">)</span></div><div class="line"><span style="color:#79C0FF">data</span><span style="color:#C9D1D9">(</span><span style="color:#A5D6FF">&quot;shares&quot;</span><span style="color:#C9D1D9">)</span></div><div class="line"><span style="color:#FFA657">industry</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FFA657">ssaggregate</span><span style="color:#C9D1D9">(</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">data</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> df,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">shares</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> shares,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">vars</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> y </span><span style="color:#FF7B72">+</span><span style="color:#C9D1D9"> x </span><span style="color:#FF7B72">+</span><span style="color:#C9D1D9"> z </span><span style="color:#FF7B72">+</span><span style="color:#C9D1D9"> l_sh_routine33,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">weights</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;wei&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">n</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;sic87dd&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">t</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;year&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">s</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;ind_share&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">l</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;czone&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">controls</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> t2 </span><span style="color:#FF7B72">+</span><span style="color:#C9D1D9"> Lsh_manuf</span></div><div class="line"><span style="color:#C9D1D9">)</span></div><div class="line"></div><div class="line"><span style="color:#79C0FF">head</span><span style="color:#C9D1D9">(industry)</span></div><div class="line"><span style="color:#8B949E">#&gt;    sic87dd  year          s_n          y          x           z l_sh_routine33</span></div><div class="line"><span style="color:#8B949E">#&gt;      &lt;num&gt; &lt;num&gt;        &lt;num&gt;      &lt;num&gt;      &lt;num&gt;       &lt;num&gt;          &lt;num&gt;</span></div><div class="line"><span style="color:#8B949E">#&gt; 1:    2011  1990 5.991178e-03  0.9038660 -0.1129257 -0.15226680      -1.065246</span></div><div class="line"><span style="color:#8B949E">#&gt; 2:    2011  2000 4.729078e-03  0.5532335  0.3898516 -0.09367913      -1.178196</span></div><div class="line"><span style="color:#8B949E">#&gt; 3:    2015  1990 3.802834e-03  0.7228411 -0.4026864  0.08561252      -2.407878</span></div><div class="line"><span style="color:#8B949E">#&gt; 4:    2015  2000 4.638681e-03 -0.1133174 -0.1762856 -0.34968672      -2.320667</span></div><div class="line"><span style="color:#8B949E">#&gt; 5:    2021  1990 8.723289e-05  2.2034699  0.1183517 -0.03164776      -2.788844</span></div><div class="line"><span style="color:#8B949E">#&gt; 6:    2021  2000 4.436779e-05  0.3604907  0.2456597 -0.39783282      -1.195864</span></div></code></div></pre>
<p>Using “wide” shares in dataset:</p>
<pre class="shiki github-dark" style="background-color:#0d1117;color:#c9d1d9"><div class="language-id">r</div><div class="code-container"><code><div class="line"><span style="color:#79C0FF">data</span><span style="color:#C9D1D9">(</span><span style="color:#A5D6FF">&quot;df_wide&quot;</span><span style="color:#C9D1D9">)</span></div><div class="line"><span style="color:#FFA657">industry_df</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FFA657">ssaggregate</span><span style="color:#C9D1D9">(</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">data</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> df_wide,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">vars</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> y </span><span style="color:#FF7B72">+</span><span style="color:#C9D1D9"> x </span><span style="color:#FF7B72">+</span><span style="color:#C9D1D9"> z </span><span style="color:#FF7B72">+</span><span style="color:#C9D1D9"> l_sh_routine33,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">weights</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;wei&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">n</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;sic87dd&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">t</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;year&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">s</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;ind_share&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">controls</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> t2 </span><span style="color:#FF7B72">+</span><span style="color:#C9D1D9"> Lsh_manuf</span></div><div class="line"><span style="color:#C9D1D9">)</span></div><div class="line"><span style="color:#8B949E">#&gt; Warning: Invalid .internal.selfref detected and fixed by taking a (shallow)</span></div><div class="line"><span style="color:#8B949E">#&gt; copy of the data.table so that := can add this new column by reference. At an</span></div><div class="line"><span style="color:#8B949E">#&gt; earlier point, this data.table has been copied by R (or was created manually</span></div><div class="line"><span style="color:#8B949E">#&gt; using structure() or similar). Avoid names&lt;- and attr&lt;- which in R currently</span></div><div class="line"><span style="color:#8B949E">#&gt; (and oddly) may copy the whole data.table. Use set* syntax instead to avoid</span></div><div class="line"><span style="color:#8B949E">#&gt; copying: ?set, ?setnames and ?setattr. If this message doesn&#39;t help, please</span></div><div class="line"><span style="color:#8B949E">#&gt; report your use case to the data.table issue tracker so the root cause can be</span></div><div class="line"><span style="color:#8B949E">#&gt; fixed or this message improved.</span></div><div class="line"></div><div class="line"><span style="color:#79C0FF">head</span><span style="color:#C9D1D9">(industry_df)</span></div><div class="line"><span style="color:#8B949E">#&gt;    sic87dd  year          s_n          y          x           z l_sh_routine33</span></div><div class="line"><span style="color:#8B949E">#&gt;     &lt;char&gt; &lt;num&gt;        &lt;num&gt;      &lt;num&gt;      &lt;num&gt;       &lt;num&gt;          &lt;num&gt;</span></div><div class="line"><span style="color:#8B949E">#&gt; 1:    2011  1990 5.991178e-03  0.9038660 -0.1129257 -0.15226680      -1.065246</span></div><div class="line"><span style="color:#8B949E">#&gt; 2:    2011  2000 4.729078e-03  0.5532335  0.3898516 -0.09367913      -1.178196</span></div><div class="line"><span style="color:#8B949E">#&gt; 3:    2015  1990 3.802834e-03  0.7228411 -0.4026864  0.08561252      -2.407878</span></div><div class="line"><span style="color:#8B949E">#&gt; 4:    2015  2000 4.638681e-03 -0.1133174 -0.1762856 -0.34968672      -2.320667</span></div><div class="line"><span style="color:#8B949E">#&gt; 5:    2021  1990 8.723289e-05  2.2034699  0.1183517 -0.03164776      -2.788844</span></div><div class="line"><span style="color:#8B949E">#&gt; 6:    2021  2000 4.436779e-05  0.3604907  0.2456597 -0.39783282      -1.195864</span></div></code></div></pre>
<p>Including the “missing industry”:</p>
<pre class="shiki github-dark" style="background-color:#0d1117;color:#c9d1d9"><div class="language-id">r</div><div class="code-container"><code><div class="line"><span style="color:#79C0FF">data</span><span style="color:#C9D1D9">(</span><span style="color:#A5D6FF">&quot;df&quot;</span><span style="color:#C9D1D9">)</span></div><div class="line"><span style="color:#79C0FF">data</span><span style="color:#C9D1D9">(</span><span style="color:#A5D6FF">&quot;shares&quot;</span><span style="color:#C9D1D9">)</span></div><div class="line"><span style="color:#FFA657">industry_df</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FFA657">ssaggregate</span><span style="color:#C9D1D9">(</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">data</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> df,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">shares</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> shares,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">vars</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> y </span><span style="color:#FF7B72">+</span><span style="color:#C9D1D9"> x </span><span style="color:#FF7B72">+</span><span style="color:#C9D1D9"> z </span><span style="color:#FF7B72">+</span><span style="color:#C9D1D9"> l_sh_routine33,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">weights</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;wei&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">n</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;sic87dd&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">t</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;year&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">s</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;ind_share&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">l</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;czone&quot;</span><span style="color:#C9D1D9">,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">controls</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> t2 </span><span style="color:#FF7B72">+</span><span style="color:#C9D1D9"> Lsh_manuf,</span></div><div class="line"><span style="color:#C9D1D9">  </span><span style="color:#FFA657">addmissing</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#79C0FF">TRUE</span></div><div class="line"><span style="color:#C9D1D9">)</span></div><div class="line"></div><div class="line"><span style="color:#79C0FF">head</span><span style="color:#C9D1D9">(industry_df)</span></div><div class="line"><span style="color:#8B949E">#&gt;    sic87dd  year          s_n          y          x           z l_sh_routine33</span></div><div class="line"><span style="color:#8B949E">#&gt;      &lt;num&gt; &lt;num&gt;        &lt;num&gt;      &lt;num&gt;      &lt;num&gt;       &lt;num&gt;          &lt;num&gt;</span></div><div class="line"><span style="color:#8B949E">#&gt; 1:    2011  1990 1.456902e-03  0.9038660 -0.1129257 -0.15226680      -1.065246</span></div><div class="line"><span style="color:#8B949E">#&gt; 2:    2011  2000 1.149991e-03  0.5532335  0.3898516 -0.09367913      -1.178196</span></div><div class="line"><span style="color:#8B949E">#&gt; 3:    2015  1990 9.247522e-04  0.7228411 -0.4026864  0.08561252      -2.407878</span></div><div class="line"><span style="color:#8B949E">#&gt; 4:    2015  2000 1.128009e-03 -0.1133174 -0.1762856 -0.34968672      -2.320667</span></div><div class="line"><span style="color:#8B949E">#&gt; 5:    2021  1990 2.121282e-05  2.2034699  0.1183517 -0.03164776      -2.788844</span></div><div class="line"><span style="color:#8B949E">#&gt; 6:    2021  2000 1.078912e-05  0.3604907  0.2456597 -0.39783282      -1.195864</span></div></code></div></pre>
<p>After aggregation, shocks and any shock-level controls can be merged on
to the new dataset. For example, after the previous command a user could
run</p>
<pre class="shiki github-dark" style="background-color:#0d1117;color:#c9d1d9"><div class="language-id">r</div><div class="code-container"><code><div class="line"><span style="color:#C9D1D9">industry_df[</span><span style="color:#79C0FF">is.na</span><span style="color:#C9D1D9">(sic87dd), sic87dd </span><span style="color:#FF7B72">:=</span><span style="color:#C9D1D9"> </span><span style="color:#79C0FF">0</span><span style="color:#C9D1D9">]</span></div><div class="line"><span style="color:#79C0FF">data</span><span style="color:#C9D1D9">(</span><span style="color:#A5D6FF">&quot;shocks&quot;</span><span style="color:#C9D1D9">)</span></div><div class="line"><span style="color:#79C0FF">data</span><span style="color:#C9D1D9">(</span><span style="color:#A5D6FF">&quot;industries&quot;</span><span style="color:#C9D1D9">)</span></div><div class="line"><span style="color:#FFA657">industry_df</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#79C0FF">merge</span><span style="color:#C9D1D9">(industry_df, shocks, </span><span style="color:#FFA657">by</span><span style="color:#FF7B72">=</span><span style="color:#79C0FF">c</span><span style="color:#C9D1D9">(</span><span style="color:#A5D6FF">&quot;sic87dd&quot;</span><span style="color:#C9D1D9">, </span><span style="color:#A5D6FF">&quot;year&quot;</span><span style="color:#C9D1D9">), </span><span style="color:#FFA657">all.x</span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9">T)</span></div><div class="line"><span style="color:#FFA657">industry_df</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#79C0FF">merge</span><span style="color:#C9D1D9">(industry_df, industries, </span><span style="color:#FFA657">by</span><span style="color:#FF7B72">=</span><span style="color:#79C0FF">c</span><span style="color:#C9D1D9">(</span><span style="color:#A5D6FF">&quot;sic87dd&quot;</span><span style="color:#C9D1D9">), </span><span style="color:#FFA657">all.x</span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9">T)</span></div><div class="line"></div><div class="line"><span style="color:#C9D1D9">industry_df[</span><span style="color:#79C0FF">is.na</span><span style="color:#C9D1D9">(g), </span><span style="color:#FFA657">let</span><span style="color:#C9D1D9">(</span><span style="color:#FFA657">g</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#79C0FF">0</span><span style="color:#C9D1D9">, </span><span style="color:#FFA657">year</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#79C0FF">0</span><span style="color:#C9D1D9">, </span><span style="color:#FFA657">sic3</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#79C0FF">0</span><span style="color:#C9D1D9">)]</span></div></code></div></pre>
<h2 id="shock-level-iv-regression-examples">Shock-level IV regression examples</h2>
<p>Basic shift-share IV:</p>
<pre class="shiki github-dark" style="background-color:#0d1117;color:#c9d1d9"><div class="language-id">r</div><div class="code-container"><code><div class="line"><span style="color:#79C0FF">fixest</span><span style="color:#FF7B72">::</span><span style="color:#FFA657">feols</span><span style="color:#C9D1D9">(y </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> year </span><span style="color:#FF7B72">|</span><span style="color:#C9D1D9"> </span><span style="color:#79C0FF">0</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">|</span><span style="color:#C9D1D9"> x </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> g, </span><span style="color:#FFA657">data</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> industry_df, </span></div><div class="line"><span style="color:#C9D1D9">              </span><span style="color:#FFA657">weights</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> s_n, </span><span style="color:#FFA657">vcov</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;hc1&quot;</span><span style="color:#C9D1D9">)</span></div><div class="line"><span style="color:#8B949E">#&gt; TSLS estimation, Dep. Var.: y, Endo.: x, Instr.: g</span></div><div class="line"><span style="color:#8B949E">#&gt; Second stage: Dep. Var.: y</span></div><div class="line"><span style="color:#8B949E">#&gt; Observations: 796 </span></div><div class="line"><span style="color:#8B949E">#&gt; Standard-errors: Heteroskedasticity-robust </span></div><div class="line"><span style="color:#8B949E">#&gt;                 Estimate Std. Error   t value   Pr(&gt;|t|)    </span></div><div class="line"><span style="color:#8B949E">#&gt; (Intercept)  0.000088298   0.024946  0.003540 9.9718e-01    </span></div><div class="line"><span style="color:#8B949E">#&gt; fit_x       -0.464302730   0.087633 -5.298243 1.5162e-07 ***</span></div><div class="line"><span style="color:#8B949E">#&gt; year        -0.000000182   0.000021 -0.008516 9.9321e-01    </span></div><div class="line"><span style="color:#8B949E">#&gt; ---</span></div><div class="line"><span style="color:#8B949E">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></div><div class="line"><span style="color:#8B949E">#&gt; RMSE: 0.009783   Adj. R2: 0.149066</span></div><div class="line"><span style="color:#8B949E">#&gt; F-test (1st stage), x: stat = 160.1    , p &lt; 2.2e-16 , on 1 and 793 DoF.</span></div><div class="line"><span style="color:#8B949E">#&gt;            Wu-Hausman: stat =   1.02823, p = 0.310884, on 1 and 792 DoF.</span></div></code></div></pre>
<p>Conditional shift-share IV with clustered standard errors:</p>
<pre class="shiki github-dark" style="background-color:#0d1117;color:#c9d1d9"><div class="language-id">r</div><div class="code-container"><code><div class="line"><span style="color:#79C0FF">fixest</span><span style="color:#FF7B72">::</span><span style="color:#FFA657">feols</span><span style="color:#C9D1D9">(y </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> year </span><span style="color:#FF7B72">|</span><span style="color:#C9D1D9"> </span><span style="color:#79C0FF">0</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">|</span><span style="color:#C9D1D9"> x </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> g, </span><span style="color:#FFA657">data</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> industry_df[g </span><span style="color:#FF7B72">&lt;</span><span style="color:#C9D1D9"> </span><span style="color:#79C0FF">45</span><span style="color:#C9D1D9">, ], </span></div><div class="line"><span style="color:#C9D1D9">              </span><span style="color:#FFA657">weights</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> s_n, </span><span style="color:#FFA657">cluster</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> sic3)</span></div><div class="line"><span style="color:#8B949E">#&gt; TSLS estimation, Dep. Var.: y, Endo.: x, Instr.: g</span></div><div class="line"><span style="color:#8B949E">#&gt; Second stage: Dep. Var.: y</span></div><div class="line"><span style="color:#8B949E">#&gt; Observations: 757 </span></div><div class="line"><span style="color:#8B949E">#&gt; Standard-errors: Clustered (sic3) </span></div><div class="line"><span style="color:#8B949E">#&gt;                Estimate Std. Error   t value   Pr(&gt;|t|)    </span></div><div class="line"><span style="color:#8B949E">#&gt; (Intercept)  0.00007456   0.000081  0.918778 3.5987e-01    </span></div><div class="line"><span style="color:#8B949E">#&gt; fit_x       -0.59570752   0.141843 -4.199764 4.8623e-05 ***</span></div><div class="line"><span style="color:#8B949E">#&gt; year        -0.00000135   0.000019 -0.070177 9.4416e-01    </span></div><div class="line"><span style="color:#8B949E">#&gt; ---</span></div><div class="line"><span style="color:#8B949E">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></div><div class="line"><span style="color:#8B949E">#&gt; RMSE: 0.009944   Adj. R2: 0.153545</span></div><div class="line"><span style="color:#8B949E">#&gt; F-test (1st stage), x: stat = 236.6     , p &lt; 2.2e-16 , on 1 and 754 DoF.</span></div><div class="line"><span style="color:#8B949E">#&gt;            Wu-Hausman: stat =   3.958e-5, p = 0.994982, on 1 and 753 DoF.</span></div></code></div></pre>
<p>Shift-share reduced form regression (<code>y</code> on <code>z</code>):</p>
<pre class="shiki github-dark" style="background-color:#0d1117;color:#c9d1d9"><div class="language-id">r</div><div class="code-container"><code><div class="line"><span style="color:#79C0FF">fixest</span><span style="color:#FF7B72">::</span><span style="color:#FFA657">feols</span><span style="color:#C9D1D9">(y </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> year </span><span style="color:#FF7B72">|</span><span style="color:#C9D1D9"> </span><span style="color:#79C0FF">0</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">|</span><span style="color:#C9D1D9"> z </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> g, </span><span style="color:#FFA657">data</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> industry_df, </span></div><div class="line"><span style="color:#C9D1D9">              </span><span style="color:#FFA657">weights</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> s_n, </span><span style="color:#FFA657">vcov</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;hc1&quot;</span><span style="color:#C9D1D9">)</span></div><div class="line"><span style="color:#8B949E">#&gt; TSLS estimation, Dep. Var.: y, Endo.: z, Instr.: g</span></div><div class="line"><span style="color:#8B949E">#&gt; Second stage: Dep. Var.: y</span></div><div class="line"><span style="color:#8B949E">#&gt; Observations: 796 </span></div><div class="line"><span style="color:#8B949E">#&gt; Standard-errors: Heteroskedasticity-robust </span></div><div class="line"><span style="color:#8B949E">#&gt;                 Estimate Std. Error   t value   Pr(&gt;|t|)    </span></div><div class="line"><span style="color:#8B949E">#&gt; (Intercept)  0.000103048   0.029114  0.003540 0.99717677    </span></div><div class="line"><span style="color:#8B949E">#&gt; fit_z       -0.318593633   0.067554 -4.716113 0.00000284 ***</span></div><div class="line"><span style="color:#8B949E">#&gt; year        -0.000000212   0.000023 -0.009319 0.99256692    </span></div><div class="line"><span style="color:#8B949E">#&gt; ---</span></div><div class="line"><span style="color:#8B949E">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></div><div class="line"><span style="color:#8B949E">#&gt; RMSE: 0.009811   Adj. R2: 0.144315</span></div><div class="line"><span style="color:#8B949E">#&gt; F-test (1st stage), z: stat = 377.3, p &lt; 2.2e-16 , on 1 and 793 DoF.</span></div><div class="line"><span style="color:#8B949E">#&gt;            Wu-Hausman: stat =  18.5, p = 1.958e-5, on 1 and 792 DoF.</span></div></code></div></pre>
<p>Shock-level balance check:</p>
<pre class="shiki github-dark" style="background-color:#0d1117;color:#c9d1d9"><div class="language-id">r</div><div class="code-container"><code><div class="line"><span style="color:#79C0FF">fixest</span><span style="color:#FF7B72">::</span><span style="color:#FFA657">feols</span><span style="color:#C9D1D9">(l_sh_routine33 </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> g </span><span style="color:#FF7B72">+</span><span style="color:#C9D1D9"> year, </span><span style="color:#FFA657">data</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> industry_df,</span></div><div class="line"><span style="color:#C9D1D9">              </span><span style="color:#FFA657">weights</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">~</span><span style="color:#C9D1D9"> s_n, </span><span style="color:#FFA657">vcov</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;hc1&quot;</span><span style="color:#C9D1D9">)</span></div><div class="line"><span style="color:#8B949E">#&gt; OLS estimation, Dep. Var.: l_sh_routine33</span></div><div class="line"><span style="color:#8B949E">#&gt; Observations: 796 </span></div><div class="line"><span style="color:#8B949E">#&gt; Standard-errors: Heteroskedasticity-robust </span></div><div class="line"><span style="color:#8B949E">#&gt;                Estimate Std. Error   t value Pr(&gt;|t|) </span></div><div class="line"><span style="color:#8B949E">#&gt; (Intercept)  0.00002335   0.009037  0.002583  0.99794 </span></div><div class="line"><span style="color:#8B949E">#&gt; g           -0.00244245   0.001645 -1.484810  0.13799 </span></div><div class="line"><span style="color:#8B949E">#&gt; year         0.00000898   0.000043  0.208076  0.83522 </span></div><div class="line"><span style="color:#8B949E">#&gt; ---</span></div><div class="line"><span style="color:#8B949E">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></div><div class="line"><span style="color:#8B949E">#&gt; RMSE: 0.018808   Adj. R2: -2.71e-4</span></div></code></div></pre>
<p><em>See Borusyak, Hull, and Jaravel (2022) for other examples of
shock-level analyses and guidance on specifying and validating a
quasi-experimental shift-share IV.</em></p>
</div>
    </div>
  </div>
</body></html>